<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <title>Orçamento por Categoria — Itens realistas e deduplicados</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet" />
  <style>
    :root { --green:#1E7E34; --ink:#1b1b1b; --bg:#fafafa; --muted:#667085 }
    * { box-sizing:border-box }
    body { margin:0; background:var(--bg); color:var(--ink); font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif }
    .wrap { max-width:1200px; margin:0 auto; padding:20px }
    header { text-align:center; padding:16px 0 }
    h1 { margin:0 0 8px; font-size:26px }
    .lead { color:var(--muted) }
    form { background:#fff; border:1px solid #eee; border-radius:12px; padding:18px }
    label { display:block; margin:12px 0 6px; font-weight:600 }
    input, textarea, select { width:100%; border:1px solid #d8dee4; border-radius:8px; padding:10px; font:inherit }
    textarea { min-height:110px; resize:vertical }
    .row3 { display:grid; grid-template-columns:1fr 1fr 1fr; gap:12px }
    button { background:var(--green); color:#fff; border:0; border-radius:10px; padding:12px 18px; font-weight:600; cursor:pointer; font-size:16px }
    .status { min-height:22px; color:var(--muted); margin:10px 0 0; font-size:14px }
    .status.error { color:#c62828 }
    .status.success { color:var(--green) }
    .table { margin-top:14px; background:#fff; border:1px solid #eee; border-radius:10px; overflow:auto }
    table { width:100%; border-collapse:collapse; font-size:13px }
    th, td { border-bottom:1px solid #eee; padding:8px 10px; vertical-align:top; word-break:break-word }
    th { background:#f6fbf6; color:#0f5132; text-align:left; position:sticky; top:0 }
    td { white-space:pre-wrap }
    .right { display:flex; gap:8px; justify-content:flex-end; flex-wrap:wrap }
    .sub { background:#fbfbfb; font-weight:600 }
  </style>
</head>
<body>
  <header class="wrap">
    <h1>Orçamento por Categoria</h1>
    <p class="lead">Itens variados e realistas por categoria, deduplicação automática, compras não recorrentes.</p>
  </header>

  <main class="wrap">
    <form id="frm" novalidate>
      <div class="row3">
        <div>
          <label>Nome do Projeto *</label>
          <input id="nomeProjeto" required placeholder="Ex.: Governança Climática nos Territórios" />
        </div>
        <div>
          <label>Idioma de saída *</label>
          <select id="lang" required>
            <option value="pt" selected>Português</option>
            <option value="en">English</option>
            <option value="es">Español</option>
          </select>
        </div>
        <div>
          <label>Duração em meses *</label>
          <select id="dur" required>
            <option value="">Selecione</option>
            <option>6</option>
            <option selected>12</option>
            <option>18</option>
            <option>24</option>
            <option>36</option>
          </select>
        </div>
      </div>

      <label>Marco Lógico em XLSX *</label>
      <input type="file" id="mlfile" accept=".xlsx,.xls" required />

      <label>Observações</label>
      <textarea id="obs" placeholder="Ex.: compras parceladas, faseamento de aquisições, regras de alocação."></textarea>

      <div class="right" style="margin-top:12px">
        <button id="btn">Gerar Orçamento</button>
      </div>
      <p class="status"></p>
    </form>

    <div id="previewBox" class="table" style="display:none">
      <table id="tbl"><thead></thead><tbody></tbody></table>
      <div class="right" style="padding:10px">
        <button id="dlXlsx">Baixar XLSX</button>
        <button id="dlCsv">Baixar CSV</button>
      </div>
    </div>
  </main>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
    const WEBHOOK_URL = "https://hook.us2.make.com/SEU_WEBHOOK_AQUI"; // opcional

    const ORDEM = ["Recursos Humanos","Prestação de Serviços","Materiais e Insumos","Equipamentos","Outros"];
    const norm  = s => String(s || "").replace(/\s+/g, " ").trim();
    const moeda = v => Intl.NumberFormat("pt-BR", { style: "currency", currency: "BRL" }).format(v);

    // Catálogo resumido mantendo os valores realistas
    const PRICE = {
      RH: { "Coordenador Geral":[9000,14000],"Gerente de Projetos":[7500,12000],"Gerente de Contratos":[7000,10000],
            "Analista Financeiro":[5000,8000],"Analista de Monitoramento":[5000,8000],"Assistente Administrativo":[2800,4500],
            "Técnico de Campo":[4000,5500],"Pedagogo":[4800,7200],"Comunicador Social":[4200,6000],
            "Designer":[3800,5500],"Motorista":[2500,3800],"Auxiliar de Logística":[2300,3500],"Estagiário":[1200,2000] },
      SERV: { "Facilitador Externo (diária)":[900,1800],"Locação de Espaço (diária)":[600,1500],"Coffee break por pessoa":[25,55],
              "Consultoria Jurídica (hora)":[300,600],"Contabilidade mensal":[1200,2600],"Tradução/Interpretação (hora)":[140,320],
              "Filmagem/Captação (diária)":[900,2200],"Fotografia (diária)":[700,1800],"Edição de Vídeo (lote)":[1500,3500],
              "Desenvolvimento Web (hora)":[120,300],"Impressão gráfica terceirizada (lote)":[800,1800],"Segurança de Evento (diária)":[350,800] },
      MAT: { "Materiais Pedagógicos (kit)":[600,1400],"Papel A4, 10 resmas":[220,360],"Cartuchos de Tinta/Toner":[350,900],
             "EPIs diversos (lote)":[400,900],"Pasta, pastas suspensas e arquivamento":[180,420],
             "Banners e lonas (lote)":[300,900],"Camisetas personalizadas, 20 un":[600,1400],"Livros e manuais (lote)":[500,1500] },
      EQP: { "Notebook (un)":[3000,6000],"Desktop (un)":[2500,5200],"Impressora (un)":[1300,2800],"Scanner (un)":[700,1800],
             "Projetor (un)":[2000,4500],"Tela de Projeção (un)":[350,900],"Câmera DSLR (un)":[2800,6500],
             "Microfone Lapela (un)":[250,800],"Caixa de Som Ativa (un)":[900,2400],"Roteador Wi-Fi Pro (un)":[350,900],
             "Switch 24 portas (un)":[900,2400],"Nobreak 1500VA (un)":[900,2100],"Drone básico (un)":[3200,6500],
             "Kit Arduino, 5 un":[500,1200],"Aluguel de Equipamentos (mês)":[700,1400] },
      OUT: { "Passagem aérea nacional (trecho)":[600,1500],"Diárias de hospedagem (un)":[180,380],
             "Transporte local aplicativo (viagem)":[25,80],"Combustível (mês)":[900,2200],"Pedágios e estacionamentos (mês)":[120,400],
             "Correios e fretes (mês)":[120,350],"Internet e telefonia (mês)":[120,280],"Seguro equipamentos (mês)":[80,250],
             "Taxas bancárias e tarifas (mês)":[50,180] }
    };
    const MIN_ITEMS = {"Recursos Humanos":8,"Prestação de Serviços":8,"Materiais e Insumos":8,"Equipamentos":10,"Outros":8};
    const mid = ([a,b]) => Math.round((a+b)/2);
    const price = (cat,item) => {
      const m = cat==="Recursos Humanos"?PRICE.RH:cat==="Prestação de Serviços"?PRICE.SERV:cat==="Materiais e Insumos"?PRICE.MAT:cat==="Equipamentos"?PRICE.EQP:PRICE.OUT;
      return mid(m[item] || [900,1200]);
    };

    function parseMarcoLogicoWB(wb){
      const sheetName = wb.SheetNames.find(n=>/marco/i.test(n)) || wb.SheetNames[0];
      const ws = wb.Sheets[sheetName];
      const aoa = XLSX.utils.sheet_to_json(ws,{header:1,raw:false});
      const items=[];
      for(const row of aoa){
        const line=row.map(c=>String(c||"").trim());
        const titulo=line[1], prazo=line[4];
        if(line[0]==='' && titulo && prazo) items.push({titulo, prazo});
      }
      return items;
    }
    function spanMeses(prazo,total){
      const p=String(prazo||"").toLowerCase();
      let ini=1, fim=total;
      const m=p.match(/m(\d+)\s*-\s*m?(\d+)/i);
      if(m){ini=+m[1]; fim=+m[2];}
      else if(/até m(\d+)/.test(p)){ini=1; fim=+p.match(/até m(\d+)/)[1];}
      else if(/a partir de m(\d+)/.test(p)){ini=+p.match(/a partir de m(\d+)/)[1]; fim=total;}
      if(ini<1)ini=1; if(fim>total)fim=total; if(fim<ini)fim=ini;
      return {ini,fim};
    }

    // Proposição (igual à versão anterior, omitido por brevidade)
    function itensPorAtividade(titulo){
      const t=titulo.toLowerCase(); const out=[];
      if(/planej|gest|coord|admin|monitor|avalia|finance/.test(t)){
        out.push(["Recursos Humanos","Coordenador Geral","mês",1,"servico"]);
        out.push(["Recursos Humanos","Analista Financeiro","mês",1,"servico"]);
        out.push(["Recursos Humanos","Analista de Monitoramento","mês",1,"servico"]);
        out.push(["Recursos Humanos","Assistente Administrativo","mês",1,"servico"]);
      }
      if(/campo|implan|execu|piloto|oficina/.test(t)){
        out.push(["Recursos Humanos","Técnico de Campo","mês",1,"servico"]);
        out.push(["Recursos Humanos","Motorista","mês",1,"servico"]);
        out.push(["Recursos Humanos","Auxiliar de Logística","mês",1,"servico"]);
      }
      if(/comunic|divulga|evento|design|mídia|foto|vídeo/.test(t)){
        out.push(["Recursos Humanos","Comunicador Social","mês",1,"servico"]);
        out.push(["Recursos Humanos","Designer","mês",1,"servico"]);
      }
      if(/educ|form|capacit|trein/.test(t)){
        out.push(["Recursos Humanos","Pedagogo","mês",1,"servico"]);
      }
      if(/capacit|trein|oficina|workshop/.test(t)){
        out.push(["Prestação de Serviços","Facilitador Externo (diária)","diária",2,"servico"]);
        out.push(["Prestação de Serviços","Locação de Espaço (diária)","diária",2,"servico"]);
        out.push(["Prestação de Serviços","Coffee break por pessoa","un",40,"servico"]);
      }
      if(/juríd|contrato/.test(t)){ out.push(["Prestação de Serviços","Consultoria Jurídica (hora)","hora",6,"servico"]); }
      if(/site|sistema|plataforma|web/.test(t)){ out.push(["Prestação de Serviços","Desenvolvimento Web (hora)","hora",20,"servico"]); }
      if(/comunic|vídeo|foto|registro/.test(t)){
        out.push(["Prestação de Serviços","Filmagem/Captação (diária)","diária",1,"servico"]);
        out.push(["Prestação de Serviços","Fotografia (diária)","diária",1,"servico"]);
        out.push(["Prestação de Serviços","Edição de Vídeo (lote)","lote",1,"servico"]);
        out.push(["Prestação de Serviços","Impressão gráfica terceirizada (lote)","lote",1,"servico"]);
      }
      if(/contáb|finance/.test(t)){ out.push(["Prestação de Serviços","Contabilidade mensal","mês",1,"servico"]); }
      if(/oficina|aula|material|didát|impress/.test(t)){
        out.push(["Materiais e Insumos","Materiais Pedagógicos (kit)","kit",2,"compra"]);
        out.push(["Materiais e Insumos","Papel A4, 10 resmas","lote",1,"compra"]);
        out.push(["Materiais e Insumos","Cartuchos de Tinta/Toner","lote",1,"compra"]);
        out.push(["Materiais e Insumos","EPIs diversos (lote)","lote",1,"compra"]);
        out.push(["Materiais e Insumos","Banners e lonas (lote)","lote",1,"compra"]);
      }
      if(/camisa|uniform/.test(t)){ out.push(["Materiais e Insumos","Camisetas personalizadas, 20 un","lote",1,"compra"]); }
      if(/bibli|conteúdo|manual|guia/.test(t)){ out.push(["Materiais e Insumos","Livros e manuais (lote)","lote",1,"compra"]); }
      if(/escrit|admin|gest|oficina|capacit|comput|ti|dados/.test(t)){
        out.push(["Equipamentos","Notebook (un)","un",2,"compra"]);
        out.push(["Equipamentos","Impressora (un)","un",1,"compra"]);
        out.push(["Equipamentos","Roteador Wi-Fi Pro (un)","un",1,"compra"]);
        out.push(["Equipamentos","Nobreak 1500VA (un)","un",1,"compra"]);
      }
      if(/apresent|audit|palestra/.test(t)){
        out.push(["Equipamentos","Projetor (un)","un",1,"compra"]);
        out.push(["Equipamentos","Tela de Projeção (un)","un",1,"compra"]);
      }
      if(/mídia|comunic|registro|foto|vídeo/.test(t)){
        out.push(["Equipamentos","Câmera DSLR (un)","un",1,"compra"]);
        out.push(["Equipamentos","Microfone Lapela (un)","un",2,"compra"]);
        out.push(["Equipamentos","Caixa de Som Ativa (un)","un",2,"compra"]);
      }
      if(/laborat|robót|arduino|maker/.test(t)){ out.push(["Equipamentos","Kit Arduino, 5 un","lote",1,"compra"]); }
      if(/alug|loca/.test(t)){ out.push(["Equipamentos","Aluguel de Equipamentos (mês)","mês",1,"servico"]); }
      if(/viagem|campo|desloc|interior|visita/.test(t)){
        out.push(["Outros","Passagem aérea nacional (trecho)","un",2,"servico"]);
        out.push(["Outros","Diárias de hospedagem (un)","un",4,"servico"]);
        out.push(["Outros","Transporte local aplicativo (viagem)","viagem",8,"servico"]);
      }
      if(/admin|escrit|gest|monitor|rotina/.test(t)){
        out.push(["Outros","Combustível (mês)","mês",1,"servico"]);
        out.push(["Outros","Pedágios e estacionamentos (mês)","mês",1,"servico"]);
        out.push(["Outros","Internet e telefonia (mês)","mês",1,"servico"]);
        out.push(["Outros","Correios e fretes (mês)","mês",1,"servico"]);
        out.push(["Outros","Seguro equipamentos (mês)","mês",1,"servico"]);
        out.push(["Outros","Taxas bancárias e tarifas (mês)","mês",1,"servico"]);
      }
      return out;
    }

    // NOVO: distribuição corrige compras não recorrentes
    function distribuir(item, ini, fim, meses, obs){
      const arr = Array(meses).fill(0);
      const qtd = item.qtd;
      const vu  = price(item.cat, item.name);
      const tipo = item.tipo;
      const un = item.un;

      const isMensal = /m[eê]s/i.test(un) || /mensal/i.test(item.name) || /Aluguel/i.test(item.name);
      const isEventoServico = /(diária|hora|viagem|pessoa|trecho)/i.test(un) && tipo==="servico";
      const pedirParcelar = /parcelad|parcelamento|fasead|entrega(s)? escalonada(s)?/i.test(obs);

      if (tipo === "servico" && isMensal) {
        for (let m = ini - 1; m < fim; m++) arr[m] += vu * qtd;
        return arr;
      }
      if (tipo === "servico" && isEventoServico) {
        const span = Math.max(1, fim - ini + 1);
        const porMes = Math.ceil(qtd / span);
        for (let m = ini - 1; m < fim; m++) arr[m] += porMes * vu;
        return arr;
      }
      // COMPRA: não recorrente por padrão
      if (tipo === "compra") {
        if (pedirParcelar && fim > ini) {
          const span = Math.max(1, fim - ini + 1);
          const parcela = (qtd * vu) / span;
          for (let m = ini - 1; m < fim; m++) arr[m] += Math.round(parcela);
        } else {
          arr[ini - 1] += qtd * vu;
        }
        return arr;
      }
      // fallback
      arr[ini - 1] += qtd * vu;
      return arr;
    }

    function orcar(ativs, meses, obs){
      const linhas = [];
      for(const at of ativs){
        const {ini,fim} = spanMeses(at.prazo, meses);
        const packs = itensPorAtividade(at.titulo);
        for(const [cat,name,un,qtd,tipo] of packs){
          const mesesVals = distribuir({cat,name,un,qtd,tipo}, ini, fim, meses, obs).map(Math.round);
          const total = mesesVals.reduce((a,v)=>a+v,0);
          linhas.push({categoria:cat,item:name,unidade:un,quantidade:qtd,valor_unitario:price(cat,name),meses:mesesVals,total});
        }
      }
      // deduplicação
      const key = l => [l.categoria,l.item,l.unidade,l.valor_unitario].join("::");
      const map = new Map();
      for(const l of linhas){
        const k = key(l);
        if(!map.has(k)) map.set(k, JSON.parse(JSON.stringify(l)));
        else{
          const acc = map.get(k);
          acc.quantidade += l.quantidade;
          acc.meses = acc.meses.map((v,i)=>v + l.meses[i]);
          acc.total += l.total;
        }
      }
      const byCat = new Map(ORDEM.map(c=>[c,[]]));
      for(const v of map.values()) byCat.get(v.categoria).push(v);

      // variedade mínima mantendo catálogo
      const catalog = {
        "Recursos Humanos": Object.keys(PRICE.RH).map(n=>[n,"mês",1,"servico"]),
        "Prestação de Serviços":[
          ["Facilitador Externo (diária)","diária",2,"servico"],["Locação de Espaço (diária)","diária",2,"servico"],
          ["Coffee break por pessoa","un",40,"servico"],["Consultoria Jurídica (hora)","hora",4,"servico"],
          ["Contabilidade mensal","mês",1,"servico"],["Tradução/Interpretação (hora)","hora",6,"servico"],
          ["Filmagem/Captação (diária)","diária",1,"servico"],["Fotografia (diária)","diária",1,"servico"],
          ["Edição de Vídeo (lote)","lote",1,"servico"],["Impressão gráfica terceirizada (lote)","lote",1,"servico"],
          ["Desenvolvimento Web (hora)","hora",20,"servico"],["Segurança de Evento (diária)","diária",1,"servico"]
        ],
        "Materiais e Insumos":[
          ["Materiais Pedagógicos (kit)","kit",2,"compra"],["Papel A4, 10 resmas","lote",1,"compra"],
          ["Cartuchos de Tinta/Toner","lote",1,"compra"],["EPIs diversos (lote)","lote",1,"compra"],
          ["Pasta, pastas suspensas e arquivamento","lote",1,"compra"],["Banners e lonas (lote)","lote",1,"compra"],
          ["Camisetas personalizadas, 20 un","lote",1,"compra"],["Livros e manuais (lote)","lote",1,"compra"]
        ],
        "Equipamentos":[
          ["Notebook (un)","un",2,"compra"],["Desktop (un)","un",1,"compra"],["Impressora (un)","un",1,"compra"],
          ["Scanner (un)","un",1,"compra"],["Projetor (un)","un",1,"compra"],["Tela de Projeção (un)","un",1,"compra"],
          ["Câmera DSLR (un)","un",1,"compra"],["Microfone Lapela (un)","un",2,"compra"],
          ["Caixa de Som Ativa (un)","un",2,"compra"],["Roteador Wi-Fi Pro (un)","un",1,"compra"],
          ["Switch 24 portas (un)","un",1,"compra"],["Nobreak 1500VA (un)","un",1,"compra"],
          ["Drone básico (un)","un",1,"compra"],["Kit Arduino, 5 un","lote",1,"compra"],
          ["Aluguel de Equipamentos (mês)","mês",1,"servico"]
        ],
        "Outros":[
          ["Passagem aérea nacional (trecho)","un",2,"servico"],["Diárias de hospedagem (un)","un",4,"servico"],
          ["Transporte local aplicativo (viagem)","viagem",8,"servico"],["Combustível (mês)","mês",1,"servico"],
          ["Pedágios e estacionamentos (mês)","mês",1,"servico"],["Correios e fretes (mês)","mês",1,"servico"],
          ["Internet e telefonia (mês)","mês",1,"servico"],["Seguro equipamentos (mês)","mês",1,"servico"],
          ["Taxas bancárias e tarifas (mês)","mês",1,"servico"]
        ]
      };

      function addIfMissing(cat, name, un, qtd, tipo){
        const exists = byCat.get(cat).some(r=>r.item===name && r.unidade===un);
        if(exists) return;
        const mesesVals = distribuir({cat,name,un,qtd,tipo}, 1, meses, meses, obs).map(Math.round);
        const total = mesesVals.reduce((a,v)=>a+v,0);
        byCat.get(cat).push({categoria:cat,item:name,unidade:un,quantidade:qtd,valor_unitario:price(cat,name),meses:mesesVals,total});
      }

      for(const cat of ORDEM){
        const need = MIN_ITEMS[cat];
        const have = byCat.get(cat).length;
        if(have < need){
          for(const def of catalog[cat]){
            addIfMissing(cat, def[0], def[1], def[2], def[3]);
            if(byCat.get(cat).length >= need) break;
          }
        }
      }

      const finalLinhas = [];
      for(const cat of ORDEM){
        const arr = byCat.get(cat);
        if(!arr || arr.length===0) continue;
        arr.sort((a,b)=>a.item.localeCompare(b.item));
        for(const l of arr) finalLinhas.push(l);
        const sub = {categoria:cat,item:"Subtotal",unidade:"",quantidade:"",valor_unitario:"",
          meses:Array(meses).fill(0), total:0, _sub:true};
        for(const l of arr){ l.meses.forEach((v,i)=>sub.meses[i]+=v); sub.total += l.total; }
        finalLinhas.push(sub);
      }
      const somaMes = Array(meses).fill(0); let somaTotal = 0;
      for(const l of finalLinhas){ if(l._sub) continue; l.meses.forEach((v,i)=>somaMes[i]+=v); somaTotal += l.total; }
      return {linhas:finalLinhas, somaMes, somaTotal};
    }

    function renderTabela(orc, meses){
      const thead=document.querySelector("#tbl thead");
      const tbody=document.querySelector("#tbl tbody");
      thead.innerHTML=""; tbody.innerHTML="";
      const trh=document.createElement("tr");
      trh.innerHTML = `<th>Categoria</th><th>Item</th><th>Unid.</th><th>Qtd.</th><th>Vlr unit.</th>` +
        Array.from({length:meses},(_,i)=>`<th>M${i+1}</th>`).join("") + `<th>Total</th>`;
      thead.appendChild(trh);
      for(const l of orc.linhas){
        const tr=document.createElement("tr");
        if(l._sub) tr.classList.add("sub");
        tr.innerHTML =
          `<td>${l.categoria}</td><td>${l.item}</td><td>${l.unidade}</td><td>${l.quantidade}</td>` +
          `<td>${l.valor_unitario?moeda(l.valor_unitario):""}</td>` +
          l.meses.map(v=>`<td>${moeda(v)}</td>`).join("") +
          `<td><b>${moeda(l.total)}</b></td>`;
        tbody.appendChild(tr);
      }
      const trT=document.createElement("tr");
      trT.classList.add("sub");
      trT.innerHTML =
        `<td colspan="5"><b>TOTAL</b></td>` +
        orc.somaMes.map(v=>`<td><b>${moeda(v)}</b></td>`).join("") +
        `<td><b>${moeda(orc.somaTotal)}</b></td>`;
      tbody.appendChild(trT);
      document.getElementById("previewBox").style.display="block";
    }

    function baixarXLSX(orc, nome, meses){
      const aoa=[]; aoa.push(["Orçamento por Categoria — Itens realistas"]); aoa.push([]);
      aoa.push(["Categoria","Item","Unidade","Quantidade","Valor unitário"].concat(Array.from({length:meses},(_,i)=>`M${i+1}`)).concat(["Total"]));
      for(const l of orc.linhas){ aoa.push([l.categoria,l.item,l.unidade,l.quantidade,l.valor_unitario].concat(l.meses).concat([l.total])); }
      aoa.push(["TOTAL","","","",""].concat(orc.somaMes).concat([orc.somaTotal]));
      const wb=XLSX.utils.book_new(); const ws=XLSX.utils.aoa_to_sheet(aoa);
      ws['!cols']=[{wch:24},{wch:36},{wch:8},{wch:8},{wch:12}].concat(Array.from({length:meses},()=>({wch:12}))).concat([{wch:14}]);
      XLSX.utils.book_append_sheet(wb, ws, "Orcamento");
      const safe=(nome||'Projeto').replace(/[^a-zA-Z0-9]/g,'_').slice(0,30);
      XLSX.writeFile(wb, `Orcamento_${safe}_${Date.now()}.xlsx`);
    }
    function baixarCSV(orc, nome, meses){
      const cols=["Categoria","Item","Unidade","Quantidade","Valor_unitario"].concat(Array.from({length:meses},(_,i)=>`M${i+1}`)).concat(["Total"]);
      const rows=orc.linhas.map(l=>[l.categoria,l.item,l.unidade,l.quantidade,l.valor_unitario].concat(l.meses).concat([l.total]));
      const total=["TOTAL","","","",""].concat(orc.somaMes).concat([orc.somaTotal]);
      const csv=[cols].concat(rows).concat([total]).map(r=>r.map(v=>`"${String(v??"").replace(/"/g,'""')}"`).join(',')).join('\n');
      const a=document.createElement('a');
      a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
      a.download=`Orcamento_${(nome||'Projeto').replace(/[^a-zA-Z0-9]/g,'_').slice(0,30)}_${Date.now()}.csv`;
      document.body.appendChild(a); a.click(); a.remove();
    }

    const frm=document.getElementById("frm");
    const dlX=document.getElementById("dlXlsx");
    const dlC=document.getElementById("dlCsv");
    let ultimo=null, mesesSel=12;

    dlX.addEventListener("click",()=>{ if(ultimo) baixarXLSX(ultimo, document.getElementById("nomeProjeto").value, mesesSel); });
    dlC.addEventListener("click",()=>{ if(ultimo) baixarCSV(ultimo, document.getElementById("nomeProjeto").value, mesesSel); });

    frm.addEventListener("submit", async e=>{
      e.preventDefault();
      const statusEl=document.querySelector(".status");
      try{
        statusEl.textContent="Processando"; statusEl.classList.remove("error","success");
        const nomeProjeto=norm(document.getElementById("nomeProjeto").value);
        const meses=parseInt(document.getElementById("dur").value||"12",10); mesesSel=meses;
        const obs=norm(document.getElementById("obs").value);
        const f=document.getElementById("mlfile").files?.[0];
        if(!nomeProjeto||!f||!meses) throw new Error("Preencha nome, duração e anexe o XLSX do Marco Lógico.");

        const buf=await f.arrayBuffer();
        const wb=XLSX.read(buf,{type:"array"});
        const ativs=parseMarcoLogicoWB(wb);

        try{
          await fetch(WEBHOOK_URL,{method:"POST",headers:{"Content-Type":"application/json"},
            body: JSON.stringify({nomeProjeto, meses, observacoes: obs, ml_xlsx_b64: btoa(String.fromCharCode(...new Uint8Array(buf)))})});
        }catch(_){}

        const orc=orcar(ativs, meses, obs);
        ultimo=orc; renderTabela(orc, meses);
        statusEl.textContent="✓ OK"; statusEl.classList.add("success");
      }catch(err){
        statusEl.textContent="Erro: "+err.message; statusEl.classList.add("error");
      }
    });
  </script>
</body>
</html>



